# SCIN ëª¨ë¸ ì¬í•™ìŠµ ê°€ì´ë“œ - ê°œì„ íŒ (Balanced Focal Loss)

## ğŸ“‹ ì¬í•™ìŠµ ë°°ê²½

### ê¸°ì¡´ ëª¨ë¸ ì„±ëŠ¥
- **ì†ì‹¤ í•¨ìˆ˜**: BCEWithLogitsLoss + í´ë˜ìŠ¤ ê°€ì¤‘ì¹˜
- **F1-Score**: 0.160
- **Top-5 Accuracy**: 62.1%
- **ë¬¸ì œì **: Threshold 0.5ê°€ ë„ˆë¬´ ë†’ì•„ ì˜ˆì¸¡ ë³´ìˆ˜ì 

### Focal Loss ì¬í•™ìŠµ ì‹¤íŒ¨ (2024-12-04)
- **ì†ì‹¤ í•¨ìˆ˜**: Focal Loss (alpha=0.25, gamma=2.0)
- **F1-Score**: 0.085 âŒ (47% ì„±ëŠ¥ ì €í•˜)
- **ë¬¸ì œì **: Major class (Eczema/ACD) ê³¼ì í•©
  - Eczema Recall: 100%, Precision: 32% (ëª¨ë“  ìƒ˜í”Œì„ Eczemaë¡œ ì˜ˆì¸¡)
  - íŒŒë¼ë¯¸í„°ê°€ ë„ˆë¬´ ê°•í•´ì„œ ì—­íš¨ê³¼ ë°œìƒ
- **ê²°ê³¼**: ì•„ì¹´ì´ë¸Œ ì²˜ë¦¬ (`archive/focal_loss_failed/`)

### ê°œì„ ëœ ì¬í•™ìŠµ ì „ëµ
- **ì†ì‹¤ í•¨ìˆ˜**: Balanced Focal Loss (alpha=0.5, gamma=1.5)
- **ë³€ê²½ì‚¬í•­**:
  - `alpha`: 0.25 â†’ **0.5** (minor class ë³´í˜¸ ê°•í™”)
  - `gamma`: 2.0 â†’ **1.5** (major class ê³¼ì í•© ì™„í™”)
  - Learning Rate: 0.0001 â†’ **0.00005** (ë” ì•ˆì •ì )
  - Batch Size: 16 â†’ **32** (ì¼ë°˜í™” í–¥ìƒ)
  - Dropout: 0.6 â†’ **0.3** (ê³¼ì í•© ì™„í™”)
- **ëª©í‘œ**: F1-Score **0.20~0.30** (ê¸°ì¡´ ëŒ€ë¹„ 25~87% í–¥ìƒ)

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### 1. ì¬í•™ìŠµ ì‹œì‘
```bash
cd /Users/kyoe/DeepLearning_project/scin/model/resnet50
./retrain_balanced.sh
```

### 2. í•™ìŠµ ëª¨ë‹ˆí„°ë§ (TensorBoard)
```bash
# ìƒˆ í„°ë¯¸ë„ì—ì„œ
cd /Users/kyoe/DeepLearning_project/scin/model/resnet50
python3 -m tensorboard.main --logdir ./logs_balanced
# ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:6007 ì ‘ì†
```

### 3. í•™ìŠµ ì™„ë£Œ í›„ í‰ê°€
```bash
# Balanced Focal Loss ëª¨ë¸ í‰ê°€
python evaluate.py \
  --checkpoint ../../checkpoints_balanced/checkpoint_best.pth \
  --output_dir ./evaluation_results_balanced \
  --threshold 0.15

# ê¸°ì¡´ ëª¨ë¸ê³¼ ë¹„êµ
python evaluate.py \
  --checkpoint ../../checkpoints/checkpoint_best.pth \
  --output_dir ./evaluation_results_old \
  --threshold 0.15
```

### 4. ì„±ëŠ¥ ë¹„êµ í›„ ëª¨ë¸ ì ìš©
```bash
# ì„±ëŠ¥ì´ ê¸°ì¡´ë³´ë‹¤ ì¢‹ìœ¼ë©´ (F1-Score > 0.160)
cd /Users/kyoe/DeepLearning_project/scin

# ê¸°ì¡´ ëª¨ë¸ ë°±ì—…
cp checkpoints/checkpoint_best.pth checkpoints/checkpoint_best_backup_$(date +%Y%m%d).pth

# ìƒˆ ëª¨ë¸ ë³µì‚¬
cp checkpoints_balanced/checkpoint_best.pth checkpoints/checkpoint_best.pth

# Flask ì„œë¹„ìŠ¤ ì¬ì‹œì‘
cd api
lsof -ti:5001 | xargs kill -9
./start.sh
```

---

## ğŸ”§ ìƒì„¸ ì„¤ì •

### ì£¼ìš” í•˜ì´í¼íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ê¸°ì¡´ (ì‹¤íŒ¨) | ê°œì„ íŒ | ì„¤ëª… |
|---------|-----------|-------|------|
| **ì†ì‹¤ í•¨ìˆ˜** | Focal Loss | Balanced Focal Loss | íŒŒë¼ë¯¸í„° ì™„í™” |
| **alpha** | 0.25 | **0.5** â†‘ | Minor class ê°€ì¤‘ì¹˜ ì¦ê°€ |
| **gamma** | 2.0 | **1.5** â†“ | ì‰¬ìš´ ìƒ˜í”Œ ë¬´ì‹œ ì™„í™” |
| **Learning Rate** | 0.0001 | **0.00005** â†“ | ë” ì•ˆì •ì  í•™ìŠµ |
| **Batch Size** | 16 | **32** â†‘ | ì¼ë°˜í™” í–¥ìƒ |
| **Dropout** | 0.6 | **0.5** â†“ | ê³¼ì í•© ì™„í™” |
| **Weight Decay** | 1e-3 | **1e-4** â†“ | L2 ì •ê·œí™” ì™„í™” |
| **Epochs** | 50 | **60** | ì¶©ë¶„í•œ ìˆ˜ë ´ ì‹œê°„ |
| **Patience** | 15 | **10** | Early stopping |

### Focal Loss ìˆ˜ì‹
```
FL(p_t) = -Î±(1-p_t)^Î³ log(p_t)

where:
  p_t = ì˜ˆì¸¡ í™•ë¥ 
  Î± = í´ë˜ìŠ¤ ê°€ì¤‘ì¹˜ (0.5 ê¶Œì¥)
  Î³ = focusing parameter (1.5 ê¶Œì¥)
```

**ì‘ë™ ì›ë¦¬:**
- `(1-p_t)^Î³`: ì‰¬ìš´ ìƒ˜í”Œ(p_t ë†’ìŒ)ì˜ lossë¥¼ ì¤„ì„
- `Î±`: Minor classì— ë” ë§ì€ ê°€ì¤‘ì¹˜ ë¶€ì—¬
- **Î³ê°€ ë‚®ì„ìˆ˜ë¡** major class ê³¼ì í•© ë°©ì§€

---

## ğŸ“Š í‰ê°€ ì§€í‘œ í•´ì„

### F1-Score ëª©í‘œ
- **í˜„ì¬ (ê¸°ì¡´ ëª¨ë¸)**: 0.160
- **ëª©í‘œ**: **0.20 ì´ìƒ** (25% í–¥ìƒ)
- **ìš°ìˆ˜**: **0.25 ì´ìƒ** (56% í–¥ìƒ)
- **ìµœê³ **: **0.30 ì´ìƒ** (87% í–¥ìƒ)

### í´ë˜ìŠ¤ë³„ ì„±ëŠ¥ í™•ì¸
```bash
# í‰ê°€ ê²°ê³¼ JSON í™•ì¸
cat evaluation_results_balanced/per_class_metrics.json | python3 -m json.tool | head -50

# Major class (Eczema, ACD) ì„±ëŠ¥ í™•ì¸
python3 << 'EOF'
import json
with open('evaluation_results_balanced/per_class_metrics.json', 'r') as f:
    metrics = json.load(f)

print("\nMajor Class ì„±ëŠ¥:")
for disease in ['Eczema', 'Allergic Contact Dermatitis']:
    m = metrics.get(disease, {})
    print(f"\n{disease}:")
    print(f"  F1-Score:  {m.get('f1', 0):.4f}")
    print(f"  Precision: {m.get('precision', 0):.4f}")
    print(f"  Recall:    {m.get('recall', 0):.4f}")
    print(f"  Support:   {m.get('support', 0)}")
EOF
```

### ì„±ê³µ ê¸°ì¤€
| ì§€í‘œ | ê¸°ì¤€ê°’ | ì„¤ëª… |
|------|--------|------|
| **Overall F1** | > 0.160 | ê¸°ì¡´ ëª¨ë¸ë³´ë‹¤ ë†’ì•„ì•¼ í•¨ |
| **Eczema Precision** | > 0.50 | 50% ì´ìƒ ì •í™•ë„ (ê¸°ì¡´ Focal: 32%) |
| **Eczema Recall** | < 0.90 | ê³¼ì í•© ë°©ì§€ (ê¸°ì¡´ Focal: 100%) |
| **Top-5 Accuracy** | > 62% | ê¸°ì¡´ ìœ ì§€ |

---

## ğŸ› ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: ì—¬ì „íˆ Eczema ê³¼ì í•©
**ì¦ìƒ:**
```python
Eczema: Precision < 0.50, Recall > 0.95
```

**í•´ê²°:**
```bash
# alphaë¥¼ ë” ë†’ì´ê³  gammaë¥¼ ë” ë‚®ì¶¤
cd /Users/kyoe/DeepLearning_project/scin/model/resnet50

python train.py \
  --data_dir ../../data/scin_processed \
  --image_root ../../data/scin_dataset \
  --checkpoint_dir ../../checkpoints_balanced2 \
  --log_dir ./logs_balanced2 \
  --loss_type focal \
  --focal_alpha 0.7 \
  --focal_gamma 1.0 \
  --batch_size 32 \
  --num_epochs 60 \
  --lr 0.00005 \
  --weight_decay 1e-4 \
  --dropout 0.5 \
  --patience 10 \
  --num_workers 0 \
  --augment
```

### ë¬¸ì œ 2: F1-Scoreê°€ ê¸°ì¡´ë³´ë‹¤ ë‚®ìŒ
**í•´ê²°:**
```bash
# ë‹¤ë¥¸ ì†ì‹¤ í•¨ìˆ˜ ì‹œë„: Asymmetric Loss
python train.py \
  --data_dir ../../data/scin_processed \
  --image_root ../../data/scin_dataset \
  --checkpoint_dir ../../checkpoints_asymmetric \
  --log_dir ./logs_asymmetric \
  --loss_type asymmetric \
  --batch_size 32 \
  --num_epochs 60 \
  --lr 0.00005 \
  --weight_decay 1e-4 \
  --dropout 0.5 \
  --patience 10 \
  --num_workers 0 \
  --augment
```

### ë¬¸ì œ 3: ë©”ëª¨ë¦¬ ë¶€ì¡± (OOM)
**í•´ê²°:**
```bash
# Batch Size ê°ì†Œ
# retrain_balanced.shì—ì„œ --batch_size 32 â†’ 16ìœ¼ë¡œ ë³€ê²½
```

### ë¬¸ì œ 4: í•™ìŠµì´ ë„ˆë¬´ ëŠë¦¼
**í˜„ì¬ ìƒí™©:**
- Apple Silicon (MPS): ì•½ 1.5~2ì‹œê°„ (60 epochs)
- CPU: ì•½ 5~6ì‹œê°„

**í•´ê²°:**
```bash
# Epochs ê°ì†Œ
# retrain_balanced.shì—ì„œ --num_epochs 60 â†’ 40ìœ¼ë¡œ ë³€ê²½
```

---

## ğŸ“‚ íŒŒì¼ êµ¬ì¡°

### í•™ìŠµ ê´€ë ¨ íŒŒì¼
```
/Users/kyoe/DeepLearning_project/scin/
â”œâ”€â”€ model/resnet50/
â”‚   â”œâ”€â”€ retrain_balanced.sh          # ê°œì„ ëœ ì¬í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ train.py                      # í•™ìŠµ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ evaluate.py                   # í‰ê°€ ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ logs_balanced/                # TensorBoard ë¡œê·¸
â”‚   â”œâ”€â”€ evaluation_results_balanced/  # í‰ê°€ ê²°ê³¼
â”‚   â””â”€â”€ evaluation_results_old/       # ê¸°ì¡´ ëª¨ë¸ í‰ê°€ (ë¹„êµìš©)
â”œâ”€â”€ checkpoints/
â”‚   â”œâ”€â”€ checkpoint_best.pth           # í˜„ì¬ ì‚¬ìš© ì¤‘ (ê¸°ì¡´ ëª¨ë¸, F1=0.160)
â”‚   â””â”€â”€ checkpoint_best_backup_*.pth  # ë°±ì—…
â”œâ”€â”€ checkpoints_balanced/             # ìƒˆë¡œ í•™ìŠµëœ ëª¨ë¸ ì €ì¥ ìœ„ì¹˜
â”‚   â”œâ”€â”€ checkpoint_best.pth           # ìµœê³  ì„±ëŠ¥ ëª¨ë¸
â”‚   â”œâ”€â”€ checkpoint_latest.pth         # ìµœì‹  ì—í¬í¬
â”‚   â””â”€â”€ checkpoint_epoch_*.pth        # 10 ì—í¬í¬ë§ˆë‹¤ ì €ì¥
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ scin_processed/               # ì „ì²˜ë¦¬ëœ ë°ì´í„°
â”‚   â”‚   â”œâ”€â”€ train.csv
â”‚   â”‚   â”œâ”€â”€ val.csv
â”‚   â”‚   â”œâ”€â”€ test.csv
â”‚   â”‚   â””â”€â”€ metadata.json
â”‚   â””â”€â”€ scin_dataset/                 # ì›ë³¸ ì´ë¯¸ì§€
â”‚       â””â”€â”€ dataset/images/*.png
â””â”€â”€ archive/
    â””â”€â”€ focal_loss_failed/            # ì‹¤íŒ¨í•œ Focal Loss ì‹œë„
        â”œâ”€â”€ checkpoints_focal/
        â”œâ”€â”€ logs_focal/
        â””â”€â”€ evaluation_results_focal/
```

---

## ğŸ”„ ì¬í•™ìŠµ í”„ë¡œì„¸ìŠ¤

### ì „ì²´ í”„ë¡œì„¸ìŠ¤
```
1. ë°ì´í„° í™•ì¸ (scin_processed/, scin_dataset/)
   â†“
2. ì¬í•™ìŠµ ì‹¤í–‰ (retrain_balanced.sh)
   â†“
3. í•™ìŠµ ëª¨ë‹ˆí„°ë§ (TensorBoard)
   â†“
4. í•™ìŠµ ì™„ë£Œ (checkpoints_balanced/)
   â†“
5. ëª¨ë¸ í‰ê°€ (evaluate.py)
   â†“
6. ì„±ëŠ¥ ë¹„êµ (F1-Score > 0.160?)
   â†“
7a. YES â†’ ëª¨ë¸ ì ìš© (checkpoints/checkpoint_best.pth êµì²´)
   â†“
   Flask ì¬ì‹œì‘
   â†“
   ìš´ì˜ í™˜ê²½ í…ŒìŠ¤íŠ¸

7b. NO â†’ í•˜ì´í¼íŒŒë¼ë¯¸í„° ì¡°ì • â†’ 2ë²ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
```

### ì˜ˆìƒ ì†Œìš” ì‹œê°„
- **ë°ì´í„° í™•ì¸**: 5ë¶„
- **ì¬í•™ìŠµ**: 1.5~2ì‹œê°„ (Apple Silicon MPS)
- **í‰ê°€**: 10ë¶„
- **ëª¨ë¸ ì ìš©**: 5ë¶„
- **ì´í•©**: **ì•½ 2~2.5ì‹œê°„**

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

### í•™ìŠµ ì „
- [ ] ë°ì´í„° ê²½ë¡œ í™•ì¸: `/Users/kyoe/DeepLearning_project/scin/data/scin_processed/`
- [ ] ì´ë¯¸ì§€ ê²½ë¡œ í™•ì¸: `/Users/kyoe/DeepLearning_project/scin/data/scin_dataset/`
- [ ] ëª¨ë“  Python ëª¨ë“ˆ ì„¤ì¹˜ í™•ì¸: `torch`, `torchvision`, `numpy`, `tqdm`, `tensorboard`
- [ ] ê¸°ì¡´ ëª¨ë¸ ë°±ì—… í™•ì¸: `checkpoints/checkpoint_best_old.pth`
- [ ] ë””ìŠ¤í¬ ìš©ëŸ‰ í™•ì¸: ìµœì†Œ 5GB ì—¬ìœ  ê³µê°„

### í•™ìŠµ ì¤‘
- [ ] TensorBoard ì‹¤í–‰ (`http://localhost:6006`)
- [ ] Loss ê°ì†Œ í™•ì¸ (Train Loss, Val Loss)
- [ ] F1-Score ì¦ê°€ í™•ì¸
- [ ] Overfitting ì§•í›„ í™•ì¸ (Train Loss â†“, Val Loss â†‘)

### í•™ìŠµ í›„
- [ ] `checkpoints_balanced/checkpoint_best.pth` ìƒì„± í™•ì¸
- [ ] í‰ê°€ ì‹¤í–‰ (`evaluate.py`)
- [ ] F1-Score > 0.160 í™•ì¸
- [ ] Major class Precision > 0.50 í™•ì¸
- [ ] Major class Recall < 0.90 í™•ì¸

### ëª¨ë¸ ì ìš© ì „
- [ ] ê¸°ì¡´ ëª¨ë¸ ë°±ì—… ìƒì„±
- [ ] ìƒˆ ëª¨ë¸ ë³µì‚¬
- [ ] Flask ì¬ì‹œì‘
- [ ] Health check (`curl http://localhost:5001/health`)
- [ ] í…ŒìŠ¤íŠ¸ ì˜ˆì¸¡ ì‹¤í–‰

---

## ğŸ“ ë„ì›€ë§

### ë¡œê·¸ í™•ì¸
```bash
# í•™ìŠµ ë¡œê·¸
tail -f /Users/kyoe/DeepLearning_project/scin/model/resnet50/logs_balanced/train.log

# Flask ë¡œê·¸
tail -f /Users/kyoe/DeepLearning_project/scin/api/flask.log
```

### ì§„í–‰ ìƒí™© í™•ì¸
```bash
# ìµœì‹  ì²´í¬í¬ì¸íŠ¸ í™•ì¸
ls -lth /Users/kyoe/DeepLearning_project/scin/checkpoints_balanced/ | head -5

# í˜„ì¬ ì—í¬í¬ í™•ì¸
python3 -c "
import torch
checkpoint = torch.load('/Users/kyoe/DeepLearning_project/scin/checkpoints_balanced/checkpoint_latest.pth', map_location='cpu', weights_only=False)
print(f'í˜„ì¬ ì—í¬í¬: {checkpoint.get(\"epoch\", \"N/A\")}')
print(f'í˜„ì¬ ê²€ì¦ ì†ì‹¤: {checkpoint.get(\"best_val_loss\", \"N/A\"):.4f}')
"
```

### ê¸´ê¸‰ ì¤‘ë‹¨
```bash
# í•™ìŠµ í”„ë¡œì„¸ìŠ¤ ì¤‘ë‹¨
ps aux | grep train.py | grep -v grep | awk '{print $2}' | xargs kill -9

# TensorBoard ì¤‘ë‹¨
lsof -ti:6006 | xargs kill -9

# Flask ì¤‘ë‹¨
lsof -ti:5001 | xargs kill -9
```

---

## ğŸ¯ ì„±ê³µ ì‚¬ë¡€ ì˜ˆìƒ

### ê°œì„ ëœ Balanced Focal Loss ëª¨ë¸ (ì˜ˆìƒ)
```
Overall F1-Score: 0.25 (ê¸°ì¡´ 0.160 â†’ 56% í–¥ìƒ)

Major Class ì„±ëŠ¥:
  Eczema:
    F1-Score:  0.55
    Precision: 0.65 (ê¸°ì¡´ Focal: 0.32 â†’ 103% í–¥ìƒ)
    Recall:    0.47 (ê¸°ì¡´ Focal: 1.00 â†’ ê³¼ì í•© í•´ì†Œ)

  Allergic Contact Dermatitis:
    F1-Score:  0.52
    Precision: 0.60
    Recall:    0.45

Top-5 Accuracy: 68% (ê¸°ì¡´ 62% â†’ 10% í–¥ìƒ)
```

ì´ ì„±ëŠ¥ì´ ë‹¬ì„±ë˜ë©´ **í”„ë¡œë•ì…˜ ì ìš© ê°€ëŠ¥**í•©ë‹ˆë‹¤! ğŸš€
